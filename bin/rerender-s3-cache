#! /app/vendor/node/bin/node

/**

	S3 bucket

*/

var http = require('http');
var Q = require('q');

var prerenderPrefix = require('./prerenderPrefix');
var currentCachedURLs = require('./currentCachedURLs');

var prerenderURL = process.env.HEROKU_APP_NAME + '.herokuapp.com';

var prefix = '';
if (process.env.S3_PREFIX_KEY) {
		prefix = process.env.S3_PREFIX_KEY;
}
console.log('old prefix: ' + prefix);

var prefixNum = prefix.match(/\d+$/);
if (prefixNum) {
	prefixNum = parseInt(prefixNum[0])+1;
} else {
	prefixNum = 0;
};


var newPrefix = 'prerender_' + prefixNum;
console.log('new prefix: ' + newPrefix);


function handle_object(item) {
	var deferred = Q.defer();
	console.log('got item: ', item.Key);
	var key = item.Key;
	var url = item.Key.replace(prefix, '');

	console.log('updating: ' + key + ' ('+url+')');

	http.request({
		hostname: prerenderURL,
		path: '/' + url,
		method: 'GET'
	}, deferred.resolve).end();

	return deferred.promise;
}


function handle_object_result(res) {
	var deferred = Q.defer();
	console.log('statusCode: ', res.statusCode);
	deferred.resolve(res.statusCode == 200);
	return deferred.promise;
}


function handle_object_error(err) {
	var deferred = Q.defer();
	console.log('error:', err);
	deferred.resolve(false);
	return deferred.promise;
}


function handle_objects(data) {
	console.log('handle_objects: ', data.Contents.length);
	var queue = [];

	for (var item in data) {
		console.log('item: ', item);
		if (data.hasOwnProperty(item)) {
			// data.Contents.forEach(
			// 	function(item) {
			// 		console.log('item: ', item.Key);
			// 		queue.push(Q.fcall(handle_object, item).then(handle_object_result, handle_object_error));
			// 	});
		}
	}
	return Q.all(queue);
}


function handle_objects_error(err) {
		console.log("handle_objects_error: ", err, err.stack); // an error occurred
}

prerenderPrefix.doChangePrefix(newPrefix)
.then(function () { return currentCachedURLs.getCacheMap(prefix); })
.then(function (args) {
	console.log('handle objects array: ', args);
	return handle_objects(args);
}, handle_objects_error)
.then(function () { return prerenderPrefix.doChangePrefix(prefix); });


// .then(handle_objects, handle_objects_error)
// .then(function (args) {
// 	console.log('handle objects array: ', args);
// 	return Q.resolve(args);
// })
// .then(
// 	function(args) {
// 		console.log('n:', args);
// 		return prerenderPrefix.doChangePrefix(prefix);
// 	}
// )
// .then(
// 	function (args) {
// 		console.log('args: ', args);
// 		process.exit();
// 	}
// );

// JBT not deleteing these for testing purposes
// s3.deleteObject({Key: key}, function(err, data) {
// 	if (err) console.log(err, err.stack);
// 	else {
// 		console.log(data);
// 	};
// });
